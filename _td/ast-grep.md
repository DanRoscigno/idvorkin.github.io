---
layout: post
title: AST Grep
permalink: /ast-grep
---

Sometimes you need to search/replace but on code, so let's use ASTs for that. The tool is called [ast-grep](https://github.com/ast-grep/ast-grep) (which you invoke with sg).

### Pet Project: Extracting all documentation from hyper-div

See the finished script [here](https://github.com/idvorkin/LinqPadSnippets/blob/d03306e30bbc467142813a5c339a0c3839f4ebc9/python/dump_hyperdiv_docs.py)

I want to create LLM consumable documentation for [hyper-div](https://docs.hyperdiv.io/). Normally, I'd use a web-crawler to do the extraction, but I can't because the pages are all generated by JavaScript and I'm too lazy to set up a crawler that's web page driven.

Now, it turns out [hyper-div documentation](https://github.com/hyperdiv/hyperdiv-docs) is generated from [Python files](https://github.com/hyperdiv/hyperdiv-docs/blob/f190f9c03830d3e7961ed0b932f0816fdd9ed91a/hyperdiv_docs/pages/guide/layout.py?plain=1#L13), and the majority of relevant docs can be extracted via the output tags, e.g., hd.markdown, hd.heading, p.title.

```python
@router.route("/guide/loops")
def loops():
    with page() as p:
        p.title("# Rendering in Loops")

        docs_markdown(
            """

            When rendering components in loops, we have to take a bit
            of extra precaution. For example, if we want to render 5
            sliders in a loop, this code will not work:
            """)

```

Now we want to extract all the documentation from the Python files. We can use ast-grep to do this.

```bash
sg --pattern 'docs_markdown($PARAM)' hyperdiv_docs/pages/**/*.py
```

We can do something more complex with rules:

```yaml
# YAML Rule is more powerful!
# https://ast-grep.github.io/guide/rule-config.html#rule
id: main
language: python
rule:
  any:
    - pattern: hd.markdown($A)
    - pattern: p.title($T)
    - pattern: docs_markdown($DM)
    - pattern: code_example($CE,$PARAM2) # code_example has 2 params
```

This has human-readable output, which we can make computer-readable with

```bash
‚ùÆ sg scan --rule doc_puller.yaml --json  |  jq -r '.[] | {file: .file, lines: .lines} | "\(.file)\n\(.lines)"'
```

### Notes

- When you're playing with this, you'll certainly want to use the [playground](https://ast-grep.github.io/playground.html)
